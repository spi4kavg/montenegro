!function(a,b){var c={fetch:function(a){return $.ajax({url:window.script_settings.fetch_url,method:"GET",dataType:"json",data:a})},fetchOne:function(a){return $.ajax({url:window.script_settings.fetch_one_url,method:"GET",dataType:"json",data:{pk:a}})},updatePassword:function(a){return $.ajax({url:window.script_settings.update_password_url,method:"POST",dataType:"json",data:a})},update:function(a){return $.ajax({url:window.script_settings.update_url,method:"POST",dataType:"json",data:a})},insert:function(a){return $.ajax({url:window.script_settings.insert_url,method:"PUT",dataType:"json",data:a})},del:function(a){return $.ajax({url:window.script_settings.delete_url,method:"DELETE",dataType:"json",data:{pk:a}})}};$(document).ready(function(){function a(){this.params={page:1},this.elements={userList:$("#user-list"),pagination:$("#pagination"),createUserButton:$("#create-user-button")},this.templates={userList:$("#user-list-template").html(),pagination:$("#pagination-template").html(),createUser:$("#create-user-template").html(),updateUser:$("#update-user-template").html(),newPassword:$("#new-password-template").html()},this.errorHandler=function(a){if(_.isObject(a))if(a.status)switch(a.status){case 401:this.errorHandler("Вы не авторизованны");break;case 404:this.errorHandler("Пользователь не найден");break;default:alert("Произошла ошибка, попробуйте позже")}else{var b=this;_.each(a.messages,function(a,c){b.find("."+c+"-error").html(a.join("<br />"))})}else _.isString(a)&&this.find(".text-danger").first().html(a)},this.refreshUserList=function(){var a=this,b=c.fetch(this.params);b.then(function(b){var c=_.template(a.templates.userList),d=c({data:b.data});a.elements.userList.html(d),$(".delete-button",a.elements.userList).click(_.bind(a.dropUser,a)),$(".update-button",a.elements.userList).click(_.bind(a.updateUser,a)),$(".new-password-button",a.elements.userList).click(_.bind(a.newPassword,a))}),b.fail(function(a){this.elements.userList.html("Ошибка")}),b.then(function(b){var c=_.template(a.templates.pagination),d=c({data:b.meta});a.elements.pagination.html(d),$(".prev-page",a.elements.pagination).click(_.bind(a.prevPage,a)),$(".next-page",a.elements.pagination).click(_.bind(a.nextPage,a))}),b.fail(function(a){this.elements.pagination.html("Ошибка")})},this.prevPage=function(){this.params.page--,this.refreshUserList()},this.nextPage=function(){this.params.page++,this.refreshUserList()},this.createUserButtonClick=function(){var a=this;$.fancybox({helpers:{title:"Создание нового пользователя"},content:this.templates.createUser,afterShow:function(){this.inner.find("form").submit(function(){var b=$(this),d={login:b.find('[name="login"]').val(),password:b.find('[name="password"]').val(),repassword:b.find('[name="repassword"]').val(),grant:b.find('[name="grant"]').is(":checked")};if(d.password===d.repassword){var e=c.insert(d);e.then(function(c){return 400===c.status_code?a.errorHandler.call(b,c):($.fancybox.close(),void a.refreshUserList())}),e.fail(function(c){a.errorHandler.call(b,c)})}else a.errorHandler.call(b,"Введенные пароли не идентичны");return!1})}})},this.dropUser=function(a){var b=confirm("Вы уверены?"),d=$(a.target).data("pk")||$(a.target).parent().data("pk"),e=b?c.del(d):!1,f=this;e&&(e.then(function(){1==$("#user-list table tbody tr").length&&f.prevPage(),f.refreshUserList()}),e.fail(function(){alert("произошла ошибка")}))},this.updateUser=function(a){var b=$(a.target).data("pk")||$(a.target).parent().data("pk"),d=c.fetchOne(b),e=this;return d.then(function(a){$.fancybox({helpers:{title:"Рекдактирование пользователя"},content:e.templates.updateUser,afterShow:function(){var b=this.inner.find("form");b.find("[name='pk']").val(a.pk),b.find("[name='login']").val(a.login),b.find("[name='grant']").prop("checked",a.grant),b.submit(function(){var a=$(this),b={pk:a.find('[name="pk"]').val(),login:a.find('[name="login"]').val(),grant:a.find('[name="grant"]').is(":checked")},d=c.update(b);return d.then(function(b){return 400===b.status_code?e.errorHandler.call(a,b):($.fancybox.close(),void e.refreshUserList())}),d.fail(function(b){e.errorHandler.call(a,b)}),!1})}})}),d.fail(function(){alert("Произошла ошибка")}),!1},this.newPassword=function(a){var b=this,d=$(a.target).data("pk")||$(a.target).parent().data("pk");return $.fancybox({helpers:{title:"Изменение пароля пользователя"},content:this.templates.newPassword,afterShow:function(a){var e=this.inner.find("form");e.find('[name="pk"]').val(d),e.submit(function(){var a=$("[name='password']",e).val(),f=$("[name='repassword']",e).val();if(a===f){var g=c.updatePassword({pk:d,password:a,repassword:f});g.then(function(a){return 400===a.status_code?b.errorHandler.call(e,a):($.fancybox.close(),void b.refreshUserList())}),g.fail(function(a){b.errorHandler.call(e,a)})}else b.errorHandler.call(b,"Введенные пароли не идентичны");return!1})}}),!1},this.refreshUserList(),this.elements.createUserButton.click(_.bind(this.createUserButtonClick,this))}new a}),b["true"]=a}({},function(){return this}());